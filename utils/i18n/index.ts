import i18n from "i18next";
import { initReactI18next } from "react-i18next";
import { getStorageItemAsync, setStorageItemAsync } from "@/hooks/useStorageState";

// 设置存储 key（与 settingsStore 保持一致）
const SETTINGS_STORAGE_KEY = "app-settings";

const resources = {
  en: {
    translation: {
      common: {
        today: "Today",
        yesterday: "Yesterday",
        time: "Time",
        error: "Error",
        cancel: "Cancel",
        saving: "Saving...",
        save: "Save",
        loading: "Loading",
        back: "Back",
        optional: "Optional",
        success: "Success",
        greeting: {
          morning: "Good morning",
          afternoon: "Good afternoon",
          evening: "Good evening",
        },
      },
      tabs: {
        index: "Home",
        history: "History",
        charts: "Stats",
        user: "User",
      },
      weather: {
        sunny: "Sunny",
        cloudy: "Cloudy",
        overcast: "Overcast",
        comfortable: "Comfortable",
        breezy: "Breezy",
        windy: "Windy",
        hot: "Hot",
        cold: "Cold",
        warm: "Warm",
        cool: "Cool",
        humid: "Humid",
        dry: "Dry",
        hazy: "Hazy",
        foggy: "Foggy",
        showery: "Showery",
        stormy: "Stormy",
        mild: "Mild",
        fresh: "Fresh",
      },
      login: {
        title: "Login here",
        registerTitle: "Create Account",
        registerDescription:
          "Create an account so you can explore all the existing jobs",
        welcome: "Welcome back you've been missed!",
        forgetPassword: "Forgot your password?",
        account: "Account",
        password: "Password",
        confirmPassword: "Confirm Password",
        createAccount: "Create new account",
        haveAccount: "Already have an account",
        continue: "Or continue with",
        login: "Sign in",
        register: "Sign up",
        confirmPasswordError: "The two passwords do not match",
      },
      home: {
        todayActivity: "Today's Activity",
        completeness: "Completeness",
        duration: "Duration",
        calories: "Calories",
        pace: "Average pace",
        stepFrequency: "Step frequency",
        totalDistance: "Total Distance",
        totalHours: "Total Hours",
        totalRuns: "Total Runs",
        startRun: "Start Run!",
        career: "Career Stats",
        recentActivities: "Recent Activities",
        showMore: "More",
      },
      charts: {
        title: "Activity Stats",
        sinceDate: "Since",
        weeklyDistance: "Distance",
        totalCalories: "Calories",
        avgPace: "Avg Pace",
        weekly: "Weekly",
        monthly: "Monthly",
        yearly: "Yearly",
        dailyDistance: "Daily Distance (km)",
        weeklyTrend: "Weekly Trend",
        dailyCalories: "Daily Calories (kcal)",
        caloriesBurned: "Calories Burned",
      },
      history: {
        outdoorRun: "Outdoor Run",
        noRecords: "No records yet",
      },
      run: {
        summary: "Run Summary",
        detail: "Run Detail",
        start: "Start",
        finish: "Finish",
        discard: "Discard",
        discardTitle: "Discard Run?",
        discardMessage: "This run will not be saved. Are you sure?",
        discardRecord: "Discard Record",
        saveRecord: "Save Record",
        editInfo: "Edit Info",
        info: "Run Info",
        addNote: "Add a note...",
        noNote: "No note",
        duration: "Duration",
        steps: "Steps",
        signal: "Signal",
        notFound: "Run record not found",
        exportTitle: "Export Run Data",
        exportMessage: "Choose export format",
        exportError: "Failed to export run data, please try again",
      },
      setting: {
        language: "Language",
        darkMode: "DarkMode",
        editProfile: "Edit Profile",
        cloudSync: "Cloud Sync",
        cloudSyncValue: "iCloud",
        map: "Map Settings",
        notify: "Notification",
        helps: "Help and Feedback",
        about: "About Us",
        logout: "Log out",
        preferences: "Preferences",
        tools: "Running Tools",
        other: "Others",
      },
      cloudSync: {
        title: "Cloud Sync",
        syncing: "Syncing...",
        restoring: "Restoring...",
        syncSuccess: "Sync Success",
        syncFailed: "Sync Failed",
        synced: "Synced",
        notSynced: "Not Synced",
        lastSync: "Last Sync",
        backupTime: "Backup Time",
        upload: "Backup Now",
        restore: "Restore",
        restoreTitle: "Restore Data",
        restoreConfirm: "This will overwrite all data on this device with the cloud backup. Continue?",
        restoreSuccess: "Restore Success",
        restoreSuccessMessage: "Data has been restored. Please restart the app to apply changes.",
        syncSettings: "Sync Settings",
        autoSync: "Auto Sync",
        autoSyncDesc: "Backup after each run",
        wifiOnly: "WiFi Only",
        wifiOnlyDesc: "Save mobile data",
        storageInfo: "Storage Info",
        databaseSize: "Database Size",
        backupSize: "Backup Size",
        cloudProvider: "Cloud Provider",
        tips: "Backups are stored in iCloud and can be restored when switching devices. iCloud backup usually happens automatically when the device is charging and connected to WiFi.",
      },
      about: {
        title: "About Us",
        slogan: "Your Best Running Companion",
        versionInfo: "Version Info",
        version: "Version",
        buildNumber: "Build Number",
        updateCheck: "Check for Updates",
        legal: "Legal",
        privacyPolicy: "Privacy Policy",
        termsOfService: "Terms of Service",
        openSource: "Open Source Licenses",
        team: "About SimRun",
        description:
          "SimRun is a professional running tracking app designed for runners who love outdoor sports. We are committed to providing accurate trajectory recording and detailed data analysis to help you better understand your running performance.",
        allRightsReserved: "All rights reserved.",
      },
      help: {
        title: "Help & Feedback",
        quickActions: "Quick Actions",
        contactUs: "Contact Us",
        userGuide: "User Guide",
        userGuideDesc: "Learn how to use SimRun",
        faq: {
          title: "Frequently Asked Questions",
          gps: {
            question: "Why is my GPS trajectory inaccurate?",
            answer:
              "GPS accuracy is affected by environmental factors. Please run in open areas and avoid tall buildings or dense tree cover. You can also try turning GPS off and on again, or restarting your phone.",
          },
          background: {
            question: "Can I record in the background?",
            answer:
              'Yes, SimRun supports background recording. Please allow location permission "Always" in settings to ensure continuous tracking when the screen is locked.',
          },
          battery: {
            question: "Will recording consume a lot of battery?",
            answer:
              "GPS recording does consume battery. It is recommended to fully charge before long runs or enable battery saver mode. We have optimized battery usage as much as possible.",
          },
          export: {
            question: "How to export running data?",
            answer:
              "Go to Run History, select a record, click the share button to export GPX file, which can be imported into other sports apps.",
          },
        },
        feedback: {
          title: "Send Feedback",
          desc: "Encountered a problem or have a suggestion? Let us know!",
          email: "Your Email",
          content: "Feedback Content",
          placeholder:
            "Please describe your problem or suggestion in detail...",
          submit: "Submit Feedback",
        },
        feedbackEmpty: "Please enter feedback content",
        feedbackSent:
          "Thank you for your feedback! We will process it as soon as possible.",
        responseTime:
          "We typically reply within 1-2 business days. For urgent issues, please contact us via email directly.",
      },
      language: {
        title: "Language",
        cn: "中文",
        en: "English",
      },
      activity: {
        distance: "Distance",
        steps: "Steps",
        energy: "Energy",
        pace: "Pace",
        runs: "Runs",
        hours: "Hours",
      },
      unit: {
        km: "km",
        mi: "mi",
        kcal: "kcal",
        hours: "h",
        minutes: "min",
        seconds: "s",
        spm: "spm",
      },
      time: {
        week: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
        months: [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ],
      },
    },
  },
  cn: {
    translation: {
      common: {
        today: "今天",
        yesterday: "昨天",
        time: "时间",
        error: "错误",
        cancel: "取消",
        saving: "保存中...",
        save: "保存",
        loading: "加载中",
        start: "开始",
        back: "返回",
        optional: "选填",
        success: "成功",
        greeting: {
          morning: "早上好",
          afternoon: "下午好",
          evening: "晚上好",
        },
      },
      tabs: {
        index: "首页",
        history: "记录",
        charts: "图表",
        user: "我的",
      },
      weather: {
        sunny: "晴朗",
        cloudy: "多云",
        overcast: "阴天",
        comfortable: "舒适",
        breezy: "微风",
        windy: "有风",
        hot: "炎热",
        cold: "寒冷",
        warm: "温暖",
        cool: "凉爽",
        humid: "潮湿",
        dry: "干燥",
        hazy: "朦胧",
        foggy: "有雾",
        showery: "阵雨",
        stormy: "雷暴",
        mild: "温和",
        fresh: "清新",
      },
      login: {
        title: "在这里登陆",
        registerTitle: "创建账户",
        registerDescription: "创建一个帐户，以便您可以探索所有现有的功能",
        welcome: "欢迎回来，我们都很想念你！",
        account: "账号",
        password: "密码",
        confirmPassword: "确认密码",
        forgetPassword: "忘记密码?",
        createAccount: "创建新账号",
        haveAccount: "已有账户",
        continue: "其他方式登陆",
        login: "登陆",
        register: "注册",
        confirmPasswordError: "两次密码不一致",
      },
      home: {
        todayActivity: "今日活动",
        completeness: "目标完成度",
        duration: "运动时长",
        calories: "运动消耗",
        pace: "平均配速",
        stepFrequency: "平均步频",
        totalDistance: "总公里",
        totalHours: "总时长",
        totalRuns: "总次数",
        startRun: "开始跑步",
        career: "生涯累计",
        recentActivities: "最近活动",
        showMore: "查看全部",
      },
      charts: {
        title: "运动统计",
        sinceDate: "至今",
        weeklyDistance: "本周里程",
        totalCalories: "总消耗",
        avgPace: "平均配速",
        weekly: "周",
        monthly: "月",
        yearly: "年",
        dailyDistance: "每日跑量 (km)",
        weeklyTrend: "本周累计趋势",
        dailyCalories: "卡路里消耗 (kcal)",
        caloriesBurned: "每日热量燃烧",
      },
      history: {
        outdoorRun: "户外跑步",
        noRecords: "暂无记录",
      },
      run: {
        summary: "跑步总结",
        detail: "跑步详情",
        start: "开始",
        finish: "结束",
        discard: "放弃",
        discardTitle: "放弃本次跑步?",
        discardMessage: "本次跑步数据将不会被保存，确定放弃吗？",
        discardRecord: "放弃记录",
        saveRecord: "保存记录",
        editInfo: "编辑信息",
        info: "跑步信息",
        addNote: "添加备注...",
        noNote: "暂无备注",
        duration: "运动时长",
        steps: "步数",
        signal: "信号强度",
        notFound: "未找到跑步记录",
        exportTitle: "导出跑步数据",
        exportMessage: "选择导出格式",
        exportError: "导出跑步数据失败，请重试",
      },
      setting: {
        language: "语言/Language",
        darkMode: "深色模式",
        editProfile: "编辑资料",
        map: "地图设置",
        cloudSync: "云端同步",
        cloudSyncValue: "iCloud",
        notify: "消息通知",
        helps: "帮助与反馈",
        about: "关于我们",
        logout: "退出登录",
        preferences: "偏好设置",
        tools: "跑步工具",
        other: "其他",
      },
      cloudSync: {
        title: "云端同步",
        syncing: "正在同步...",
        restoring: "正在恢复...",
        syncSuccess: "同步成功",
        syncFailed: "同步失败",
        synced: "已同步",
        notSynced: "未同步",
        lastSync: "上次同步",
        backupTime: "备份时间",
        upload: "立即备份",
        restore: "恢复数据",
        restoreTitle: "恢复数据",
        restoreConfirm: "这将用云端备份覆盖当前设备上的所有数据。确定要继续吗？",
        restoreSuccess: "恢复成功",
        restoreSuccessMessage: "数据已成功恢复，请重启应用以应用更改。",
        syncSettings: "同步设置",
        autoSync: "自动同步",
        autoSyncDesc: "跑步结束后自动备份",
        wifiOnly: "仅 WiFi 同步",
        wifiOnlyDesc: "节省移动数据流量",
        storageInfo: "存储信息",
        databaseSize: "数据库大小",
        backupSize: "备份大小",
        cloudProvider: "云服务",
        tips: "备份文件存储在 iCloud 中，可在更换设备时恢复数据。iCloud 备份通常在设备充电且连接 WiFi 时自动进行。",
      },
      about: {
        title: "关于我们",
        slogan: "您最好的跑步伴侣",
        versionInfo: "版本信息",
        version: "版本号",
        buildNumber: "构建号",
        updateCheck: "检查更新",
        legal: "法律信息",
        privacyPolicy: "隐私政策",
        termsOfService: "用户协议",
        openSource: "开源许可",
        team: "关于 SimRun",
        description:
          "SimRun 是一款专为热爱户外运动的跑者设计的专业跑步记录应用。我们致力于提供精准的轨迹记录和详细的数据分析，帮助您更好地了解自己的跑步表现。",
        allRightsReserved: "版权所有",
      },
      help: {
        title: "帮助与反馈",
        quickActions: "快速操作",
        contactUs: "联系我们",
        userGuide: "使用指南",
        userGuideDesc: "了解如何使用 SimRun",
        faq: {
          title: "常见问题",
          gps: {
            question: "为什么我的 GPS 轨迹不准确？",
            answer:
              "GPS 精度受环境影响。请在开阔地带跑步，避免高楼或茂密树木遮挡。您也可以尝试重新开关 GPS 或重启手机。",
          },
          background: {
            question: "可以后台记录吗？",
            answer:
              '是的，SimRun 支持后台记录。请在设置中允许"始终"位置权限，以确保锁屏时持续追踪。',
          },
          battery: {
            question: "记录会消耗很多电量吗？",
            answer:
              "GPS 记录确实会消耗电量。建议长跑前充满电，或开启省电模式。我们已尽可能优化电池使用。",
          },
          export: {
            question: "如何导出跑步数据？",
            answer:
              "进入跑步记录，选择某条记录，点击分享按钮可导出 GPX 文件，可导入其他运动 App。",
          },
        },
        feedback: {
          title: "发送反馈",
          desc: "遇到问题或有建议？告诉我们！",
          email: "您的邮箱",
          content: "反馈内容",
          placeholder: "请详细描述您的问题或建议...",
          submit: "提交反馈",
        },
        feedbackEmpty: "请输入反馈内容",
        feedbackSent: "感谢您的反馈！我们会尽快处理。",
        responseTime:
          "我们通常会在 1-2 个工作日内回复。紧急问题请直接邮件联系。",
      },
      language: {
        title: "语言设置",
        cn: "中文",
        en: "English",
      },
      activity: {
        distance: "距离",
        steps: "平均步频",
        energy: "运动消耗",
        pace: "平均配速",
        runs: "跑步数",
        hours: "总时长",
      },
      unit: {
        kcal: "千卡",
        km: "公里",
        mi: "米",
        hours: "小时",
        minutes: "分",
        seconds: "秒",
        spm: "步/分",
      },
      time: {
        week: ["周一", "周二", "周三", "周四", "周五", "周六", "周日"],
        months: [
          "1月",
          "2月",
          "3月",
          "4月",
          "5月",
          "6月",
          "7月",
          "8月",
          "9月",
          "10月",
          "11月",
          "12月",
        ],
      },
    },
  },
};

// 从 settings 存储中获取语言
const getLanguageFromSettings = async (): Promise<string | null> => {
  try {
    const stored = await getStorageItemAsync(SETTINGS_STORAGE_KEY) as string | null;
    if (stored) {
      const parsed = JSON.parse(stored);
      return parsed.language || null;
    }
  } catch (error) {
    console.error("Failed to get language from settings:", error);
  }
  return null;
};

// 初始化 i18n
const initI18n = async () => {
  // 首先尝试从新的 settings 存储读取
  let savedLang = await getLanguageFromSettings();

  // 如果没找到，尝试旧 key（兼容旧版本）
  if (!savedLang) {
    savedLang = await getStorageItemAsync("app-language") as string | null;
  }

  i18n.use(initReactI18next).init({
    resources,
    lng: savedLang || "cn",
    interpolation: {
      escapeValue: false, // react already safes from xss
    },
  });
};

initI18n();

export default i18n;
